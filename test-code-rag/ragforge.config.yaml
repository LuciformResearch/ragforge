name: test-code-rag
version: 1.0.0
description: Test project for code RAG with source adapter

source:
  type: code
  adapter: typescript
  root: .
  include:
    - "src/**/*.ts"
  exclude:
    - "**/node_modules/**"
    - "**/dist/**"
  options:
    exportXml: false

neo4j:
  uri: ${NEO4J_URI}
  database: neo4j
  username: ${NEO4J_USERNAME}
  password: ${NEO4J_PASSWORD}

# LLM configuration for summarization
summarization_llm:
  provider: gemini
  model: gemini-2.0-flash-exp
  temperature: 0.3
  max_tokens: 8000  # Generous limit to ensure complete responses

# Entity schema (will be auto-detected from source)
entities:
  - name: Scope
    unique_field: uuid
    searchable_fields:
      - name: source
        type: string
        summarization:
          enabled: true
          strategy: code_analysis
          threshold: 300
          output_fields:
            - purpose
            - operation
            - dependency
            - concept
            - complexity
            - suggestion
          rerank_use: prefer_summary

          # Graph context enrichment - fetch related data for each scope
          context_query: |
            MATCH (n:Scope {uuid: $uuid})-[:DEFINED_IN]->(file:File)
            OPTIONAL MATCH (n)-[:IMPORTS]->(imported:Scope)
            OPTIONAL MATCH (caller:Scope)-[:CALLS]->(n)
            OPTIONAL MATCH (n)-[:CALLS]->(called:Scope)
            RETURN
              file.path as file_path,
              n.type as scope_type,
              n.startLine as start_line,
              n.endLine as end_line,
              n.exported as is_exported,
              collect(DISTINCT imported.name)[..10] as imports_internal,
              collect(DISTINCT caller.name)[..10] as called_by,
              collect(DISTINCT called.name)[..10] as calls_internal

          # Intelligent batching - group by file for better context
          # Note: summary_hash condition is added automatically based on --force flag
          batch_order_query: |
            MATCH (n:Scope)-[:DEFINED_IN]->(file:File)
            WHERE n.source IS NOT NULL
              AND size(n.source) > $threshold
            WITH file, n
            ORDER BY file.path, n.startLine
            RETURN n.uuid AS uuid,
                   n.source AS fieldValue
