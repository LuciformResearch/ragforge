# Context Regeneration - 6 Dec 2025, 10h55

## Project Overview

**RagForge** is a meta-framework for generating RAG (Retrieval-Augmented Generation) frameworks from Neo4j schemas. It parses codebases, ingests them into Neo4j as a knowledge graph, and generates TypeScript clients for querying.

### Package Structure

```
/home/luciedefraiteur/LR_CodeRag/ragforge/
├── packages/
│   ├── cli/           # CLI commands (create, quickstart, init, generate, embeddings)
│   ├── core/          # Core functionality (adapters, tools, utils)
│   └── runtime/       # Runtime agents and execution
└── examples/
    ├── test-ingestion/     # New test project for incremental ingestion
    ├── langchainjs-analysis/
    └── test-project/
```

Related package:
```
/home/luciedefraiteur/LR_CodeRag/packages/codeparsers/  # @luciformresearch/codeparsers
├── src/
│   ├── html/              # HTMLDocumentParser (Vue, Svelte, Astro)
│   ├── typescript/        # TypeScript parser
│   ├── python/            # Python parser
│   ├── scope-extraction/  # ScopeExtractionParser
│   └── wasm/              # WasmLoader for tree-sitter
```

---

## Recent Changes (This Session)

### 1. PackageJson Ingestion

**Files modified:**
- `packages/core/src/runtime/adapters/code-source-adapter.ts`

**What was added:**
- `PackageJsonInfo` interface for parsed package.json data
- `isPackageJson()` method to detect package.json files
- `parsePackageJson()` method to extract dependencies, scripts, etc.
- PackageJson nodes with `pkg:` prefix for UUID (deterministic via `UniqueIDHelper`)
- `PACKAGE_OF` relationship (PackageJson → Project)
- Auto-discovery of package.json files in `discoverFiles()`

**Node properties:**
```typescript
{
  uuid: 'pkg:${deterministicUUID}',
  file: 'package.json',
  name: string,
  version: string,
  dependencies: string[],      // Array of dependency names
  devDependencies: string[],
  peerDependencies: string[],
  scripts: string[],           // Array of script names
  main?: string,
  moduleType?: 'module' | 'commonjs',
  hash: string,
  indexedAt: string
}
```

### 2. UUID Property on All Nodes

**Problem:** Relationships use `MATCH (from {uuid: relData.from})` but File/Directory nodes didn't have `uuid` property, causing silent relationship creation failures.

**Solution:** Added `uuid` property to all node types:
- File: `uuid: 'file:${relPath}'`
- Directory: `uuid: 'dir:${path}'`
- PackageJson: `uuid: 'pkg:${deterministicUUID}'`
- WebDocument: `uuid: 'webdoc:${uuid}'`
- Scope: `uuid: '${deterministicUUID}'` (already had it)
- Project: `uuid: 'project:${name}'` (already had it)

### 3. Quickstart.ts Updates

**File:** `packages/cli/src/commands/quickstart.ts`

**Changes:**
- Added `packageJsonNodes` and `webDocumentNodes` filtering
- Added batch creation for PackageJson and WebDocument nodes
- Added constraints for PackageJson and WebDocument
- Updated `getNodeType()` to handle `pkg:` and `webdoc:` prefixes
- Updated `getNodeInfo()` to return correct label/key for each type
- Changed relationship matching to NOT strip prefix for uuid-based types

**Key functions:**
```typescript
const getNodeType = (id: string): string => {
  if (id.startsWith('file:')) return 'file';
  if (id.startsWith('dir:')) return 'dir';
  if (id.startsWith('lib:')) return 'lib';
  if (id.startsWith('project:')) return 'project';
  if (id.startsWith('pkg:')) return 'pkg';
  if (id.startsWith('webdoc:')) return 'webdoc';
  return 'scope';
};

const getNodeInfo = (type: string): { label: string; key: string } => {
  switch (type) {
    case 'file': return { label: 'File', key: 'path' };
    case 'dir': return { label: 'Directory', key: 'path' };
    case 'lib': return { label: 'ExternalLibrary', key: 'name' };
    case 'project': return { label: 'Project', key: 'name' };
    case 'pkg': return { label: 'PackageJson', key: 'uuid' };
    case 'webdoc': return { label: 'WebDocument', key: 'uuid' };
    default: return { label: 'Scope', key: 'uuid' };
  }
};
```

### 4. Incremental Ingestion Updates

**File:** `packages/core/src/runtime/adapters/incremental-ingestion.ts`

**Change:** Added structural nodes (Project, PackageJson, Directory, File) to ingestion alongside Scope nodes:
```typescript
const projectNodes = nodes.filter(n => n.labels.includes('Project'));
const packageJsonNodes = nodes.filter(n => n.labels.includes('PackageJson'));
const directoryNodes = nodes.filter(n => n.labels.includes('Directory'));
const fileNodes = nodes.filter(n => n.labels.includes('File'));
const structuralNodes = [...projectNodes, ...packageJsonNodes, ...directoryNodes, ...fileNodes];
```

### 5. install_package Tool

**File:** `packages/core/src/tools/file-tools.ts`

**Added:**
- `generateInstallPackageTool()` - Tool definition for MCP
- `generateInstallPackageHandler()` - Validates package name, checks existing deps, runs `npm install`

---

## HTML/WebDocument Parser Architecture

### Location
`/home/luciedefraiteur/LR_CodeRag/packages/codeparsers/src/html/`

### Files
- `HTMLDocumentParser.ts` - Main parser using tree-sitter-html
- `DOMTree.ts` - In-memory DOM representation with query methods
- `types.ts` - TypeScript interfaces

### Current Capabilities
- Parse HTML, Vue SFC, Svelte, Astro files
- Extract inline `<script>` content and parse with TypeScript parser
- Detect `<script src="...">` external references (stored as metadata, not parsed)
- Extract `<style>` content (not CSS-parsed)
- Detect component usage (PascalCase/kebab-case elements)
- Extract images (`<img src="...">`)
- Vue-specific: @click handlers, v-model bindings

### Missing (TODO)
- External CSS detection (`<link rel="stylesheet" href="...">`)
- CSS parsing for selectors/properties analysis
- Relationships from WebDocument to external script files
- Scopes from inline scripts linked back to WebDocument

### Integration in Ragforge

**File:** `packages/core/src/runtime/adapters/code-source-adapter.ts`

WebDocument nodes are created with:
- `BELONGS_TO` → Project
- `DEFINED_IN` → File
- `HAS_IMAGE` → Image nodes

---

## Node Types and Relationships

### Node Types
| Label | UUID Format | Unique Key |
|-------|------------|------------|
| Scope | `{uuid}` | uuid |
| File | `file:{path}` | path |
| Directory | `dir:{path}` | path |
| Project | `project:{name}` | name |
| PackageJson | `pkg:{uuid}` | uuid |
| WebDocument | `webdoc:{uuid}` | uuid |
| ExternalLibrary | `lib:{name}` | name |
| Image | `img:{docUuid}:{line}` | - |

### Relationships
| Type | From | To |
|------|------|-----|
| DEFINED_IN | Scope | File |
| BELONGS_TO | Scope, File, WebDocument | Project |
| PACKAGE_OF | PackageJson | Project |
| HAS_PARENT | Scope | Scope |
| CONSUMES | Scope | Scope |
| USES_LIBRARY | Scope | ExternalLibrary |
| INHERITS_FROM | Scope | Scope |
| HAS_IMAGE | WebDocument | Image |

---

## Testing

### Test Project
```bash
cd /home/luciedefraiteur/LR_CodeRag/ragforge/examples/test-ingestion
```

Created with:
```bash
node ../packages/cli/dist/esm/index.js create test-ingestion --dev
```

Neo4j running on: `bolt://localhost:7694`

### Verify Ingestion
```bash
cd .ragforge/generated
npm run ingest  # Incremental ingestion
```

Query Neo4j:
```typescript
// Check node counts
MATCH (n) RETURN labels(n)[0] as label, count(n) as count ORDER BY label

// Check PackageJson
MATCH (p:PackageJson) RETURN p.name, p.version, p.dependencies

// Check DEFINED_IN relationships
MATCH (s:Scope)-[r:DEFINED_IN]->(f:File) RETURN s.name, f.path

// Check PACKAGE_OF
MATCH (p:PackageJson)-[r:PACKAGE_OF]->(proj:Project) RETURN p.name, proj.name
```

---

## Next Steps (Planned)

1. **HTML Parser Enhancements (codeparsers)**
   - Add `<link rel="stylesheet" href="...">` extraction
   - Return external script/style refs in `DocumentInfo`

2. **Ragforge Integration**
   - Create relationships from WebDocument to external script Files
   - Create relationships from WebDocument to external CSS Files
   - Ensure external files are parsed if in include patterns

3. **CSS Parser (future)**
   - Parse CSS files for selectors, properties
   - Create CSS-specific nodes/relationships

---

## Key Files Reference

| Purpose | File |
|---------|------|
| CLI entry | `packages/cli/src/index.ts` |
| Create command | `packages/cli/src/commands/create.ts` |
| Quickstart command | `packages/cli/src/commands/quickstart.ts` |
| Code source adapter | `packages/core/src/runtime/adapters/code-source-adapter.ts` |
| Incremental ingestion | `packages/core/src/runtime/adapters/incremental-ingestion.ts` |
| File tools (install_package) | `packages/core/src/tools/file-tools.ts` |
| HTML parser | `/home/luciedefraiteur/LR_CodeRag/packages/codeparsers/src/html/HTMLDocumentParser.ts` |
| DOM tree | `/home/luciedefraiteur/LR_CodeRag/packages/codeparsers/src/html/DOMTree.ts` |

---

## Common Commands

```bash
# Build ragforge
cd /home/luciedefraiteur/LR_CodeRag/ragforge && npm run build

# Create new project with local CLI
node packages/cli/dist/esm/index.js create my-project --dev

# Run ingestion in a project
cd .ragforge/generated && npm run ingest

# Query Neo4j (from generated folder)
npx tsx -e "import { config } from 'dotenv'; config({ override: true }); ..."
```
